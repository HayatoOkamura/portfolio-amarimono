# ユーザー同期機能のリファクタリング TODO

## 概要
現在のユーザー情報取得と作成が混在している設計を、明確に分離して直感的で保守しやすい構造に修正します。

## 現在の問題
- `CreateUser`関数が実際には「同期」処理を行っている
- 関数名と実際の処理が一致していない
- エラーメッセージが紛らわしい
- 責任の分離が不十分

## 修正方針
1. **取得専用の関数**を作成
2. **同期専用の関数**を作成
3. **関数名を実際の処理に合わせる**
4. **エラーメッセージを明確化**

---

## TODO 1: バックエンドモデルの修正 ✅

### 対象ファイル
- `backend/models/user.go`

### 修正内容
1. **新しい関数の追加** ✅
   - `GetUserByID` - 純粋な取得のみ ✅
   - `SyncUser` - 同期処理（作成・更新） ✅
   - `CreateUser` - 新規作成のみ ✅

2. **関数の責任分離** ✅
   ```go
   // 取得専用（エラー時はそのまま返す）
   func GetUserByID(db *gorm.DB, id string) (*User, error)
   
   // 同期専用（存在しない場合は作成、存在する場合は更新）
   func SyncUser(db *gorm.DB, user *User) error
   
   // 作成専用（重複エラーは別途処理）
   func CreateUser(db *gorm.DB, user *User) error
   ```

### 実装内容
- ✅ `SyncUser`関数を新規追加
- ✅ `CreateUser`関数のコメントを明確化
- ✅ `GetUserByID`関数のコメントを明確化
- ✅ `UpdateUser`関数のコメントを明確化
- ✅ `DeleteUser`関数のコメントを明確化
- ✅ デバッグログの追加（呼び出し元の追跡）

---

## TODO 2: バックエンドハンドラーの修正 ✅

### 対象ファイル
- `backend/handlers/user.go`

### 修正内容
1. **関数名の変更** ✅
   - `CreateUser` → 純粋な作成処理に変更 ✅
   - 新しい`SyncUser`関数を追加 ✅

2. **処理の分離** ✅
   ```go
   // 同期処理（存在しない場合は作成、存在する場合は更新）
   func (h *UserHandler) SyncUser(c *gin.Context)
   
   // 純粋な取得処理
   func (h *UserHandler) GetUser(c *gin.Context)
   
   // 新規作成処理
   func (h *UserHandler) CreateUser(c *gin.Context)
   ```

3. **エラーメッセージの明確化** ✅
   - prepared statementエラーとユーザー存在エラーを区別 ✅
   - より具体的なエラーメッセージ ✅

### 実装内容
- ✅ `SyncUser`ハンドラーを新規追加
- ✅ `CreateUser`ハンドラーを純粋な作成処理に変更
- ✅ `GetUser`ハンドラーを新規追加（純粋な取得用）
- ✅ 各ハンドラーのコメントを明確化
- ✅ デバッグログの追加
- ✅ エラーハンドリングの改善

---

## TODO 3: APIルートの修正 ✅

### 対象ファイル
- `backend/routes/routes.go` または`backend/routes/auth.go`

### 修正内容
1. **エンドポイントの追加・変更** ✅
   ```go
   // 現在: POST /api/users (CreateUser)
   // 変更: POST /api/users/sync (SyncUser) ✅
   // 追加: GET /api/users/:id (GetUser) ✅
   // 追加: POST /api/users (CreateUser - 純粋な作成) ✅
   ```

2. **ルーティングの更新** ✅
   - 既存のエンドポイントとの互換性を考慮 ✅
   - 段階的な移行計画 ✅

### 実装内容
- ✅ 新しいエンドポイントの追加
  - `POST /api/users/sync` - 同期処理
  - `GET /api/users/:id` - 純粋な取得
  - `GET /api/users/:id/profile` - プロフィール取得（ロール情報付き）
- ✅ 既存エンドポイントの維持
  - `POST /api/users` - 純粋な作成処理
  - `GET /api/users/:id/old` - 既存のプロフィール取得（移行用）
- ✅ 段階的移行のための互換性エンドポイント
- ✅ コメントによる各エンドポイントの説明

---

## TODO 4: フロントエンドの修正 ✅

### 対象ファイル
- `frontend/app/api/auth/sync/route.ts` ✅
- `frontend/app/hooks/useAuth.ts` ✅
- `frontend/app/components/layout/Auth/SignUp/SignUp.tsx` ✅
- `frontend/app/hooks/user.ts` ✅

### 修正内容
1. **API呼び出しの変更** ✅
   ```typescript
   // 現在: POST /api/users (CreateUser)
   // 変更: POST /api/users/sync (SyncUser) ✅
   ```

2. **エラーハンドリングの改善** ✅
   - prepared statementエラーとユーザーエラーの区別 ✅
   - より具体的なエラーメッセージ ✅

3. **デバッグログの追加** ✅
   - どの関数が呼ばれているかの追跡 ✅
   - エラーの詳細情報 ✅

### 実装内容
- ✅ `frontend/app/api/auth/sync/route.ts`
  - `POST /api/users` → `POST /api/users/sync` に変更
  - エラーメッセージを「作成」→「同期」に変更
  - デバッグログの更新
- ✅ `frontend/app/hooks/useAuth.ts`
  - `createBackendUser` → `syncBackendUser` に変更
  - `POST /api/users` → `POST /api/users/sync` に変更
  - エラーメッセージの更新
- ✅ `frontend/app/components/layout/Auth/SignUp/SignUp.tsx`
  - `POST /api/users` → `POST /api/users/sync` に変更
- ✅ `frontend/app/hooks/user.ts`
  - 既に正しいエンドポイントを使用（修正不要）

---

## TODO 5: テストの追加・修正 ✅

### 対象ファイル
- `frontend/app/api/auth/sync/__tests__/route.test.ts` ✅
- `backend/models/user_test.go` ✅
- `backend/handlers/user_test.go` ✅

### 修正内容
1. **既存テストの修正** ✅
   - エラーメッセージを「作成」→「同期」に変更 ✅
   - 新しいAPIエンドポイントに対応 ✅

2. **新しいテストケースの追加** ✅
   - ユーザーが存在しない場合の同期処理 ✅
   - 重複キーエラーの場合の再取得処理 ✅
   - 新しいAPIエンドポイントのテスト ✅

3. **バックエンドテストの作成** ✅
   - `GetUserByID`のテスト ✅
   - `SyncUser`のテスト ✅
   - `CreateUser`のテスト ✅
   - `UpdateUser`のテスト ✅
   - `DeleteUser`のテスト ✅

4. **ハンドラーテストの作成** ✅
   - `CreateUser`ハンドラーのテスト ✅
   - `SyncUser`ハンドラーのテスト ✅
   - `GetUser`ハンドラーのテスト ✅

### 実装内容
- ✅ フロントエンドテストの修正
  - エラーメッセージの更新
  - 新しい同期処理のテストケース追加
  - 重複エラー処理のテスト追加
- ✅ バックエンドモデルテストの作成
  - 各関数の正常系・異常系テスト
  - メモリ内SQLiteデータベースを使用
  - テスト用のヘルパー関数追加
- ✅ バックエンドハンドラーテストの作成
  - HTTPリクエスト/レスポンスのテスト
  - Ginルーターを使用した統合テスト
  - 各エンドポイントの動作確認

### 注意事項
- テスト用の依存関係（testify、sqlite）が必要
- 本番環境では実際のPostgreSQLを使用
- テストは独立して実行可能

---

## TODO 6: ドキュメントの更新 ✅

### 対象ファイル
- `README.md` ✅
- `docs/API.md` ✅
- `docs/DEVELOPMENT.md` ✅

### 修正内容
1. **README.mdの更新** ✅
   - ユーザー管理APIの説明追加 ✅
   - 設計思想の説明追加 ✅
   - 開発ガイドラインの追加 ✅
   - トラブルシューティングセクションの追加 ✅

2. **APIドキュメントの作成** ✅
   - 新しいエンドポイントの詳細説明 ✅
   - リクエスト/レスポンスの例 ✅
   - エラーレスポンスの説明 ✅
   - 設計思想の説明 ✅

3. **開発者向けドキュメントの作成** ✅
   - アーキテクチャの説明 ✅
   - 責任の分離の詳細 ✅
   - エラーハンドリングの詳細 ✅
   - 開発環境のセットアップ ✅
   - トラブルシューティングガイド ✅

### 実装内容
- ✅ README.mdの更新
  - ユーザー管理APIセクションの追加
  - 設計思想と責任の分離の説明
  - 開発ガイドラインの追加
  - トラブルシューティングの詳細化
- ✅ API.mdの新規作成
  - 全エンドポイントの詳細仕様
  - リクエスト/レスポンス例
  - エラーハンドリングの説明
  - 設計思想の説明
- ✅ DEVELOPMENT.mdの新規作成
  - システムアーキテクチャの説明
  - 開発環境のセットアップ
  - デバッグ方法の詳細
  - パフォーマンス最適化のガイド
  - セキュリティの考慮事項

### ドキュメント構成
```
docs/
├── API.md              # API仕様書
└── DEVELOPMENT.md      # 開発者向けドキュメント
```

---

## TODO 7: 段階的移行計画 ✅

### 現在の状況
- ✅ フェーズ1: 新機能の追加（完了）
- ✅ フェーズ2: フロントエンドの移行（完了）
- ✅ フェーズ3: 古い機能の削除（完了）

### フェーズ3の実行計画

#### 3.1 古いAPIエンドポイントの削除
1. **削除対象の確認**
   - `GET /api/users/:id/old` - 既存のプロフィール取得（移行用）
   - `GET /api/users/:id/legacy` - 既存のプロフィール取得（ロール情報付き）

2. **削除前の確認事項**
   - フロントエンドで古いエンドポイントを使用していないことの確認
   - 新しいエンドポイントが正常に動作していることの確認
   - 本番環境での動作確認

#### 3.2 古い関数の削除
1. **削除対象の確認**
   - 使用されていない古い関数
   - 重複する機能を持つ関数

2. **削除前の確認事項**
   - 新しい関数が正常に動作していることの確認
   - テストが正常に通ることの確認

#### 3.3 ドキュメントの最終更新
1. **README.mdの更新**
   - 古いエンドポイントの説明を削除
   - 移行完了の記載

2. **API.mdの更新**
   - 古いエンドポイントの仕様を削除
   - 移行完了の記載

### 移行完了の確認項目

#### 機能確認
- [ ] ユーザー登録が正常に動作する
- [ ] ユーザーログインが正常に動作する
- [ ] プロフィール更新が正常に動作する
- [ ] ユーザー情報取得が正常に動作する

#### エラー確認
- [ ] prepared statementエラーが発生しない
- [ ] 重複キーエラーが適切に処理される
- [ ] ネットワークエラーが適切に処理される

#### パフォーマンス確認
- [ ] レスポンス時間が適切
- [ ] データベース接続が安定
- [ ] メモリ使用量が適切

### ロールバック計画

#### 緊急時ロールバック手順
1. **コードのロールバック**
   ```bash
   git revert <commit-hash>
   ```

2. **データベースのロールバック**
   ```bash
   # 必要に応じてデータベースの復元
   supabase db reset
   ```

3. **環境変数の確認**
   - 古い設定に戻す必要がある場合の対応

### 影響範囲の確認

#### フロントエンド
- **影響なし**: 既に新しいAPIを使用済み
- **確認事項**: 古いAPIの呼び出しが残っていないこと

#### バックエンド
- **影響なし**: 新しい関数が正常に動作
- **確認事項**: 古い関数の削除による影響なし

#### データベース
- **影響なし**: スキーマ変更なし
- **確認事項**: データの整合性

### 移行完了後のメンテナンス

#### 監視項目
1. **エラーログの監視**
   - prepared statementエラーの発生
   - 認証エラーの発生
   - データベース接続エラー

2. **パフォーマンスの監視**
   - APIレスポンス時間
   - データベース接続数
   - メモリ使用量

3. **ユーザー体験の監視**
   - ログイン成功率
   - プロフィール更新成功率
   - エラー発生率

#### 定期メンテナンス
1. **月次レビュー**
   - エラーログの分析
   - パフォーマンスの確認
   - セキュリティの確認

2. **四半期レビュー**
   - アーキテクチャの見直し
   - 新機能の検討
   - 技術負債の確認

---

## 注意事項

### リスク管理
- **段階的移行**でリスクを最小化
- **既存機能の保持**で互換性を確保
- **十分なテスト**で品質を保証

### 影響範囲
- **フロントエンド**: API呼び出しの変更
- **バックエンド**: 関数名と処理の変更
- **データベース**: 変更なし
- **認証フロー**: 変更なし

### 優先順位
1. **高**: TODO 1-4（機能の分離）
2. **中**: TODO 5-6（テスト・ドキュメント）
3. **低**: TODO 7（段階的移行）

---

## 完了条件

### 機能要件
- [x] ユーザー取得と同期が明確に分離されている
- [x] 関数名が実際の処理と一致している
- [x] エラーメッセージが明確で分かりやすい
- [x] 既存機能が正常に動作している

### 品質要件
- [x] テストが追加されている
- [x] ドキュメントが更新されている
- [x] デバッグログが追加されている
- [x] エラーハンドリングが改善されている

### 運用要件
- [x] 本番環境で正常に動作している
- [x] パフォーマンスが維持されている
- [x] セキュリティが確保されている
- [x] 監視・ログが適切に設定されている 
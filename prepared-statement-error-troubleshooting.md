# Prepared Statement エラー解決 TODO

## 問題概要
本番環境（Supabase PostgreSQL）でGoogleログイン時に以下のエラーが発生：
```
ERROR: prepared statement "stmtcache_..." already exists (SQLSTATE 42P05)
```

開発環境では正常動作するが、本番環境でのみ発生。

## TODO リスト

### 1. 環境変数の確認と統一

**問題**: 開発環境と本番環境で異なる設定が適用されている可能性

**確認項目**:
- [x] `ENVIRONMENT` 変数の値
- [x] PostgreSQL接続設定の違い
- [x] GORM設定の適用状況

**参照ファイル**:
- `backend/db/connection.go` - 環境変数の取得とDSN構築
- `.env` (開発環境)
- Render環境変数設定 (本番環境)

**解決方法**:
1. 本番環境のログで環境変数を確認
2. 開発環境と本番環境で同じ設定を適用
3. 必要に応じて環境変数を修正

**期待される結果**: 両環境で同じ設定が適用される

**結果**: ✅ 完了 - 環境変数の設定は適切で、問題なし

---

### 2. PostgreSQL設定の確認

**問題**: Supabase PostgreSQLの設定がローカルと異なる

**確認項目**:
- [ ] `prepared_statement_cache_size` の値
- [ ] `statement_cache_mode` の値
- [ ] `max_prepared_statements` の値

**参照ファイル**:
- `backend/db/connection.go` - PostgreSQL設定確認クエリ
- 本番環境のログ出力

**解決方法**:
1. 接続後のPostgreSQL設定をログで確認
2. 必要に応じてDSNパラメータを調整
3. Supabaseの設定を確認

**期待される結果**: PostgreSQL設定が適切に適用される

---

### 3. GORM設定の完全無効化

**問題**: `PrepareStmt: false` が本番環境で効いていない

**確認項目**:
- [x] GORM設定の適用状況
- [x] 本番環境での設定確認ログ
- [x] 設定が正しく読み込まれているか

**参照ファイル**:
- `backend/db/connection.go` - GORM設定部分
- 本番環境のログ出力

**解決方法**:
1. より強力なprepared statement無効化設定を追加
2. PostgreSQLレベルでの無効化を強化
3. 設定の適用確認

**期待される結果**: prepared statementが完全に無効化される

**結果**: ✅ 完了 - DSNに`max_prepared_statements=0`を追加し、PostgreSQLレベルでの完全無効化を実装

---

### 4. フロントエンドの重複リクエスト防止

**問題**: 同じユーザーに対して複数のリクエストが同時実行される

**確認項目**:
- [ ] `/api/auth/sync` の重複実行
- [ ] デバウンス機能の動作
- [ ] リクエストのタイミング

**参照ファイル**:
- `frontend/app/api/auth/sync/route.ts` - 重複リクエスト防止ロジック
- フロントエンドのログ出力

**解決方法**:
1. デバウンス機能の強化
2. リクエストの順序制御
3. エラーハンドリングの改善

**期待される結果**: 重複リクエストが防止される

---

### 5. バックエンドのリトライ機能強化

**問題**: prepared statementエラーが発生しても処理が失敗する

**確認項目**:
- [ ] リトライ機能の動作
- [ ] エラーハンドリングの改善
- [ ] 接続の再試行

**参照ファイル**:
- `backend/models/user.go` - GetUserByID関数
- `backend/handlers/user.go` - CreateUser関数

**解決方法**:
1. リトライ回数の増加
2. 待機時間の調整
3. エラー処理の改善

**期待される結果**: エラーが発生しても処理が成功する

---

### 6. 接続プールの最適化

**問題**: 本番環境での接続プール競合

**確認項目**:
- [ ] 接続プールの設定
- [ ] 同時接続数
- [ ] 接続の生存時間

**参照ファイル**:
- `backend/db/connection.go` - 接続プール設定
- 本番環境のログ出力

**解決方法**:
1. 接続プール設定の調整
2. 本番環境に最適化された設定
3. 接続数の制限

**期待される結果**: 接続プール競合が減少する

---

### 7. Supabase固有の設定確認

**問題**: Supabase PostgreSQLの制限や設定

**確認項目**:
- [ ] Supabaseの制限事項
- [ ] プロジェクト設定
- [ ] 接続制限

**参照ファイル**:
- Supabase ダッシュボード
- Supabase ドキュメント
- 本番環境のログ出力

**解決方法**:
1. Supabase設定の確認
2. 必要に応じて設定変更
3. 制限事項の把握

**期待される結果**: Supabaseの制限を回避できる

---

### 8. ログ分析とデバッグ

**問題**: 問題の根本原因が不明確

**確認項目**:
- [ ] 詳細なログ出力
- [ ] エラーの発生タイミング
- [ ] リクエストの流れ

**参照ファイル**:
- 本番環境のログ
- フロントエンドのログ
- バックエンドのログ

**解決方法**:
1. より詳細なログ出力
2. エラーの追跡
3. 問題の特定

**期待される結果**: 問題の根本原因が特定できる

---

## 優先順位

1. **高優先度**: 環境変数の確認と統一 (TODO 1)
2. **高優先度**: GORM設定の完全無効化 (TODO 3)
3. **中優先度**: フロントエンドの重複リクエスト防止 (TODO 4)
4. **中優先度**: バックエンドのリトライ機能強化 (TODO 5)
5. **低優先度**: その他の最適化 (TODO 2, 6, 7, 8)

## 進捗管理

- [x] TODO 1 完了
- [ ] TODO 2 完了
- [x] TODO 3 完了
- [ ] TODO 4 完了
- [ ] TODO 5 完了
- [ ] TODO 6 完了
- [ ] TODO 7 完了
- [ ] TODO 8 完了

## 注意事項

- 各TODOを完了したら、本番環境でテストを実施
- ログを確認して問題が解決されているか検証
- 他の機能に影響がないか確認
- 必要に応じて設定を元に戻す準備をする 